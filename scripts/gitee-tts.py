import requests
import time
import json
import webbrowser

API_URL = "https://ai.gitee.com/v1/async/audio/speech"
API_TOKEN = "FB8F11UGSXAMARF1TZLJJA82D4KOBY1CLMS6JD13"
headers = {
    "Authorization": f"Bearer {API_TOKEN}"
}

def query(payload):
    response = requests.post(API_URL, headers=headers, json=payload)
    return response.json()

def poll_task(task_id):
    status_url = f"https://ai.gitee.com/v1/task/{task_id}"
    timeout = 30 * 60
    retry_interval = 10
    attempts = 0
    max_attempts = int(timeout / retry_interval)
    while attempts < max_attempts:
        attempts += 1
        print(f"Checking task status [{attempts}]...", end="")
        response = requests.get(status_url, headers=headers, timeout=10)
        result = response.json()
        if result.get("error"):
            print('error')
            raise ValueError(f"{result['error']}: {result.get('message', 'Unknown error')}")
        status = result.get("status", "unknown")
        print(status)
        if status == "success":
            if "output" in result and "file_url" in result["output"]:
                file_url = result["output"]["file_url"]
                duration = (result.get('completed_at', 0) - result.get('started_at', 0)) / 1000
                print(f"ðŸ”— Download link: {file_url}")
                print(f"â±ï¸ Task duration: {duration:.2f} seconds")
                # Open the result URL in the browser
                webbrowser.open(file_url)
            else:
                print("âš ï¸ No output URL found")
        elif status in ["failed", "cancelled"]:
            print(f"âŒ Task {status}")
        else:
            time.sleep(retry_interval)
            continue
        task_file = f"task_{task_id}.json"
        with open(task_file, "w") as f:
            json.dump(result, f, indent=4)
        print(f"Task was saved to file {task_file}")
        return result
    print(f"â° Maximum attempts reached ({max_attempts})")
    return {"status": "timeout", "message": "maximum wait time exceeded"}

if __name__ == "__main__":
    print("Creating task...")
    result = query({
        "inputs": "[S1]è¯¶ï¼Œæˆ‘æœ€è¿‘çœ‹äº†ä¸€ç¯‡è®²äººå·¥æ™ºèƒ½çš„æ–‡ç« ï¼Œè¿˜æŒºæœ‰æ„æ€çš„ï¼Œæƒ³è·Ÿä½ èŠèŠã€‚[S2]å“¦ï¼Ÿæ˜¯å—ï¼Œå…³äºŽå•¥çš„å•Šï¼Ÿåˆæ˜¯å“ªä¸ªå…¬å¸å‘äº†ä»€ä¹ˆé€†å¤©çš„æ–°æ¨¡åž‹å—ï¼Ÿ[S1]é‚£å€’ä¸æ˜¯ï¼Œæ˜¯ä¸€ä¸ªå’±ä»¬å›½å†…çš„æ•™æŽˆï¼Œå¤æ—¦å¤§å­¦çš„é‚±é”¡é¹æ•™æŽˆï¼Œä»–æäº†ä¸€ä¸ªæ–°æ¦‚å¿µï¼Œå«ä»€ä¹ˆï¼Œå‘ƒï¼Œå«æƒ…å¢ƒæ‰©å±•ï¼ŒContext Scalingã€‚[S2]Context Scalingï¼Ÿæƒ…å¢ƒæ‰©å±•ï¼Ÿå¬èµ·æ¥æœ‰ç‚¹ï¼Œå‘ƒï¼Œæœ‰ç‚¹çŽ„ä¹Žå•Šï¼Œè¿™æ˜¯ä¸ªå•¥æ„æ€ï¼Ÿ[S1]å¯¹ï¼Œæˆ‘ä¸€å¼€å§‹ä¹Ÿè§‰å¾—æœ‰ç‚¹æŠ½è±¡ï¼Œä½†ä½ çœ‹å®Œå°±è§‰å¾—ï¼Œè¯¶ï¼Œç‰¹åˆ«æœ‰é“ç†ã€‚ä»–å¤§æ¦‚æ„æ€å°±æ˜¯è¯´å•Šï¼Œå’±ä»¬çŽ°åœ¨å¯¹äººå·¥æ™ºèƒ½çš„è¿½æ±‚ï¼Œä¸èƒ½å…‰æ˜¯æŠŠå®ƒåšå¾—æ›´å¤§ï¼Œä½ çŸ¥é“å§ï¼Œå°±æ˜¯ä¸èƒ½å…‰å †å‚æ•°ï¼Œå–‚æ•°æ®ã€‚[S2]å—¯ï¼Œæ˜¯ï¼Œè¿™ä¸ªæˆ‘æ‡‚ã€‚å°±å¥½åƒä¹‹å‰å¤§å®¶éƒ½åœ¨æ¯”è°çš„æ¨¡åž‹å‚æ•°å¤šï¼Œå‡ åƒäº¿ï¼Œä¸Šä¸‡äº¿çš„ã€‚[S1]å¯¹å¯¹å¯¹ï¼Œå°±æ˜¯é‚£ä¸ªæ„æ€ã€‚ä»–è¯´é‚£ä¸ªæ—¶ä»£ï¼Œç®—æ˜¯ç¬¬ä¸€å¹•ï¼Œå°±æ˜¯æ¨¡åž‹è§„æ¨¡åŒ–çš„èƒœåˆ©ï¼Œé å †æ–™ï¼Œå †å‡ºäº†åƒè¿™ä¸ªChatGPTè¿™æ ·åŽ‰å®³çš„é€šç”¨æ¨¡åž‹ã€‚[S2]å—¯ï¼Œæ˜¯çš„ã€‚[S1]ç„¶åŽå‘¢ï¼ŒçŽ°åœ¨å·®ä¸å¤šæ˜¯ç¬¬äºŒå¹•ï¼Œå°±æ˜¯å¤§å®¶å‘çŽ°å…‰å †æ–™å¥½åƒä¸è¡Œäº†ï¼Œæ”¶ç›Šè¶Šæ¥è¶Šå°ï¼Œå°±å¼€å§‹æžä¸€äº›ï¼Œå‘ƒï¼ŒåŽè®­ç»ƒçš„ä¼˜åŒ–ã€‚[S2]å“¦ï¼ŒåŽè®­ç»ƒä¼˜åŒ–ï¼Ÿæ¯”å¦‚å‘¢ï¼Ÿ[S1]æ¯”å¦‚è®©AIå­¦ä¼šç”¨å·¥å…·ï¼Œæˆ–è€…æžé‚£ä¸ªä»€ä¹ˆæ€ç»´é“¾ï¼Œè®©å®ƒåƒäººä¸€æ ·ä¸€æ­¥ä¸€æ­¥æ€è€ƒé—®é¢˜ï¼Œè¿˜æœ‰å°±æ˜¯å¼ºåŒ–å­¦ä¹ ï¼Œè®©å®ƒè‡ªå·±åœ¨æ¸¸æˆé‡Œæˆ–è€…å†™ä»£ç çš„æ—¶å€™è‡ªå·±è·Ÿè‡ªå·±çŽ©ï¼Œç„¶åŽè¶Šå˜è¶Šå¼ºã€‚[S2]å“¦ï¼Œæ˜Žç™½äº†ã€‚å°±æ˜¯è®©å®ƒä¸å…‰æ˜¯çŸ¥è¯†å¤šï¼Œè¿˜å¾—ä¼šç”¨ï¼Œå˜å¾—æ›´èªæ˜Žï¼Œæ˜¯è¿™ä¸ªæ„æ€å§ã€‚[S1]æ²¡é”™ï¼Œå°±æ˜¯è¿™ä¸ªç†å„¿ã€‚ä½†æ˜¯å‘¢ï¼Œè¿™ä¸¤æ­¥èµ°å®Œäº†ï¼Œå°±é‡åˆ°äº†æ–°çš„ç“¶é¢ˆã€‚é‚±æ•™æŽˆå°±è§‰å¾—ï¼Œå…³é”®é—®é¢˜å‡ºåœ¨äº†è¿™ä¸ªæƒ…å¢ƒï¼Œä¹Ÿå°±æ˜¯Contextä¸Šã€‚[S2]å—¯ï¼Ÿæƒ…å¢ƒï¼Ÿ[S1]æ˜¯ã€‚å¾ˆå¤šæ—¶å€™AIåšä¸å‡ºæ­£ç¡®çš„å†³å®šï¼Œä¸æ˜¯å› ä¸ºå®ƒç¬¨ï¼Œè€Œæ˜¯å› ä¸ºå®ƒæ²¡æžæ˜Žç™½çŽ°åœ¨åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆæƒ…å†µï¼Œå°±æ˜¯æˆ‘ä»¬ç»™å®ƒçš„ä»»åŠ¡æˆ–è€…æƒ…å¢ƒæè¿°å¾—ä¸å¤Ÿæ¸…æ¥šã€‚[S2]å“¦ï¼ŒåŽŸæ¥æ˜¯è¿™æ ·ã€‚[S1]å¯¹ã€‚æ‰€ä»¥ä»–è§‰å¾—ä¸‹ä¸€å¹•ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸‰å¹•ï¼Œå°±åº”è¯¥æ˜¯è¿™ä¸ªæƒ…å¢ƒæ‰©å±•ï¼ŒContext Scalingã€‚æ ¸å¿ƒå°±æ˜¯è¦è®©AIèƒ½çœŸæ­£ç†è§£é‚£ç§ç‰¹åˆ«å¤æ‚ã€å¤šå˜ï¼Œç”šè‡³æœ‰ç‚¹æ¨¡ç³Šçš„çœŸå®žä¸–ç•Œçš„æƒ…å¢ƒã€‚[S2]å—¯ï¼Œè¿™ä¸ªå¬èµ·æ¥å°±é«˜çº§äº†ã€‚é‚£ä»–è¯´çš„è¿™ä¸ªæƒ…å¢ƒï¼Œåˆ°åº•æŒ‡ä»€ä¹ˆå•Šï¼Ÿä¸å°±æ˜¯æˆ‘ä»¬è¾“è¿›åŽ»çš„é‚£æ®µè¯å—ï¼Ÿ[S1]è¯¶ï¼Œä¸æ˜¯é‚£ä¹ˆç®€å•çš„ã€‚ä»–è¯´çš„æƒ…å¢ƒå•Šï¼Œæ˜¯ä¸ªç‰¹åˆ«ç«‹ä½“çš„ä¸œè¥¿ã€‚å®ƒä¸å…‰åŒ…æ‹¬ä½ è¯´äº†ä»€ä¹ˆï¼Œè¿˜åŒ…æ‹¬ï¼Œå‘ƒï¼Œæ—¶é—´ï¼Œåœ°ç‚¹ï¼Œè°åœ¨è¯´è¯ï¼Œç›®çš„æ˜¯ä»€ä¹ˆï¼Œç”šè‡³è¿˜åŒ…æ‹¬å’±ä»¬æ–‡åŒ–é‡Œé‚£ç§åªå¯æ„ä¼šä¸å¯è¨€ä¼ çš„è§„åˆ™ï¼Œè¿˜æœ‰äººä¸Žäººä¹‹é—´çš„é‚£ç§é»˜å¥‘ã€‚[S2]å“‡ï¼Œé‚£è¿™ä¸ªèŒƒå›´å¯å¤ªå¹¿äº†ã€‚[S1]æ˜¯å§ã€‚ä»–ä¸¾äº†ä¸ªä¾‹å­ï¼Œå°±æ¯”å¦‚è¯´ï¼Œå½“ä¸€ä¸ªäººè¯´ä¸è¦çš„æ—¶å€™ã€‚[S2]å—¯ã€‚[S1]ä½ æƒ³æƒ³ï¼Œåœ¨ä¸åŒçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªä¸è¦çš„æ„æ€å®Œå…¨ä¸ä¸€æ ·ã€‚æœ‰å¯èƒ½æ˜¯çœŸçš„æ‹’ç»ï¼Œä¹Ÿå¯èƒ½æ˜¯åœ¨å¼€çŽ©ç¬‘ï¼Œç”šè‡³å¯èƒ½æ˜¯ä¸€ç§åå‘çš„è¯·æ±‚ï¼Œå°±æ˜¯æˆ‘ä»¬è¯´çš„å£æ˜¯å¿ƒéžï¼Œå˜´ä¸Šè¯´ä¸è¦ï¼Œèº«ä½“å¾ˆè¯šå®žé‚£ç§ã€‚[S2]å“ˆå“ˆï¼Œç¡®å®žç¡®å®žï¼Œè¿™ä¸ªAIå¯æ€Žä¹ˆåˆ¤æ–­å•Šã€‚[S1]å¯¹å•Šï¼Œæ‰€ä»¥å°±éœ€è¦ç†è§£æ•´ä¸ªæƒ…å¢ƒã€‚ä»–è¯´è¿™ä¸ªé‡Œé¢æœ€å…³é”®çš„ï¼Œå°±æ˜¯è¦æ•èŽ·ä¸€ç§å«æš—çŸ¥è¯†çš„ä¸œè¥¿ã€‚[S2]æš—çŸ¥è¯†ï¼Ÿå¬ç€åƒæ­¦æž—ç§˜ç±ä¸€æ ·ã€‚[S1]æœ‰ç‚¹é‚£ä¸ªæ„æ€ã€‚å°±æ˜¯æŒ‡æˆ‘ä»¬äººç±»ä¼šï¼Œä½†æ˜¯å¾ˆéš¾ç”¨è¯­è¨€æ¸…æ¥šåœ°è®²å‡ºæ¥çš„é‚£äº›èƒ½åŠ›ã€‚[S2]å“¦ï¼Ÿæ¯”å¦‚è¯´ï¼Ÿ[S1]æ¯”å¦‚è¯´ç¤¾äº¤çš„æ™ºæ…§å•Šï¼Œæ€Žä¹ˆé€šè¿‡ä¸€ä¸ªçœ¼ç¥žï¼Œä¸€ä¸ªåœé¡¿ï¼Œæˆ–è€…è¯­æ°”å˜åŒ–æ¥ç†è§£å¯¹æ–¹çš„æ„æ€ã€‚[S2]å—¯ï¼Œæ˜¯çš„ã€‚[S1]è¿˜æœ‰å°±æ˜¯æ–‡åŒ–é€‚åº”èƒ½åŠ›ï¼Œåœ¨ä¸åŒçš„æ–‡åŒ–é‡Œï¼Œæœ‰äº›äº‹èƒ½åšï¼Œæœ‰äº›äº‹ä¸èƒ½åšï¼Œè¿™äº›éƒ½æ²¡äººå†™åœ¨ä¹¦ä¸Šï¼Œä½†æˆ‘ä»¬å°±æ˜¯çŸ¥é“ã€‚[S2]æ²¡é”™ã€‚[S1]ä»–è¯´AIè¦æ˜¯èƒ½å­¦ä¼šè¿™äº›ï¼Œé‚£æ‰ç®—æ˜¯çœŸæ­£çš„æ™ºèƒ½çªç ´äº†ã€‚è¿™ä¹Ÿèƒ½è§£å†³ä¸€äº›AIå®‰å…¨çš„é—®é¢˜ï¼Œæ¯”å¦‚é‚£ä¸ªå¾ˆæœ‰åçš„å›žå½¢é’ˆæ‚–è®ºã€‚[S2]å“¦ï¼Œé‚£ä¸ªæˆ‘çŸ¥é“ï¼Œå°±æ˜¯ä½ è®©AIé€ å›žå½¢é’ˆï¼Œå®ƒæœ€åŽå¯èƒ½ä¼šä¸ºäº†è¿™ä¸ªç›®æ ‡æŠŠæ•´ä¸ªä¸–ç•Œéƒ½ç»™å äº†ï¼Œç”¨æ¥é€ å›žå½¢é’ˆã€‚[S1]å¯¹ã€‚ä½†å¦‚æžœå®ƒæœ‰æƒ…å¢ƒæ™ºèƒ½ï¼Œå®ƒå°±èƒ½ç†è§£æˆ‘ä»¬äººç±»ç¤¾ä¼šçš„å¤æ‚æ€§ï¼ŒçŸ¥é“æœ‰äº›äº‹æ˜¯ä¸èƒ½åšçš„ï¼Œå°±ç®—ä½ æ²¡æœ‰æ˜Žç¡®ä¸‹æŒ‡ä»¤ç¦æ­¢å®ƒã€‚[S2]æœ‰é“ç†ï¼Œæœ‰é“ç†ã€‚é‚£ï¼Œé‚£æŠ€æœ¯ä¸Šè¦æ€Žä¹ˆå®žçŽ°å‘¢ï¼Ÿå¬èµ·æ¥å¥½éš¾å•Šã€‚[S1]æ˜¯æŒºéš¾çš„ã€‚ä»–æäº†ä¸‰å¤§æŠ€æœ¯æ”¯æŸ±ã€‚ç¬¬ä¸€ä¸ªå«å¼ºäº¤äº’æ€§ã€‚å°±æ˜¯AIè¦ä¸åœåœ°è·ŸçŽ¯å¢ƒï¼Œç‰¹åˆ«æ˜¯è·Ÿäººæ¥äº’åŠ¨å­¦ä¹ ï¼Œä¸å…‰è¦çŸ¥é“æ€Žä¹ˆåšï¼Œè¿˜è¦çŸ¥é“ä¸ºä»€ä¹ˆè¿™ä¹ˆåšã€‚[S2]å—¯ï¼Œåœ¨äº’åŠ¨é‡Œå­¦ä¹ ã€‚[S1]ç¬¬äºŒä¸ªå«å…·èº«æ€§ã€‚å°±æ˜¯AIå¾—æœ‰ä¸ªèº«ä½“ï¼Œä¸ä¸€å®šæ˜¯çœŸçš„äººå½¢æœºå™¨äººï¼Œåœ¨è™šæ‹Ÿä¸–ç•Œé‡Œä¹Ÿè¡Œï¼Œæ€»ä¹‹å®ƒå¾—èƒ½æ„ŸçŸ¥å’Œè¡ŒåŠ¨ã€‚[S2]å“¦ï¼Œæ˜Žç™½ã€‚[S1]ç¬¬ä¸‰ä¸ªï¼Œæˆ‘è§‰å¾—æ˜¯æœ€ç‰¹åˆ«çš„ï¼Œå«æ‹ŸäººåŒ–ã€‚[S2]æ‹ŸäººåŒ–ï¼Ÿ[S1]å¯¹ï¼Œå°±æ˜¯è¯´AIéœ€è¦æœ‰ç±»ä¼¼äººç±»çš„æƒ…æ„Ÿå…±é¸£èƒ½åŠ›ã€‚ä¸æ˜¯å‡è£…æœ‰æ„Ÿæƒ…ï¼Œè€Œæ˜¯çœŸæ­£ç†è§£äººçš„æƒ…ç»ªï¼Œäººçš„åå¥½ï¼Œæ‡‚å¾—ç¤¾äº¤çš„è·ç¦»æ„Ÿï¼Œä»€ä¹ˆæ—¶å€™è¯¥å…³å¿ƒï¼Œä»€ä¹ˆæ—¶å€™è¯¥ä¿æŒæ²‰é»˜ã€‚[S2]å“‡ï¼Œè¿™ä¸ªè¦æ±‚å¯å¤ªé«˜äº†ï¼Œæ„Ÿè§‰æ¯”å…»ä¸ªå­©å­è¿˜éš¾ã€‚[S1]å“ˆå“ˆï¼Œå¯ä¸æ˜¯å˜›ã€‚æ‰€ä»¥ä»–è¯´è¿™äº‹å„¿å§ï¼Œä¸æ˜¯è¦åŽ»æ›¿ä»£å…¶ä»–çš„æŠ€æœ¯è·¯çº¿ï¼Œè€Œæ˜¯æŠŠå®ƒä»¬éƒ½æ•´åˆèµ·æ¥ã€‚åƒä»€ä¹ˆæŽ¨ç†å¢žå¼ºå•Šï¼Œå¤šæ¨¡æ€å•Šï¼Œå¼ºåŒ–å­¦ä¹ å•Šï¼Œæœ€ç»ˆéƒ½æ˜¯ä¸ºäº†æœåŠ¡äºŽä¸€ä¸ªç›®æ ‡ï¼Œå°±æ˜¯è®©AIèƒ½æ·±åˆ»åœ°ç†è§£æƒ…å¢ƒã€‚[S2]å—¯ã€‚[S1]æ‰€ä»¥æ€»çš„æ¥è¯´ï¼Œå°±æ˜¯åˆ«å…‰åœ¨å·²æœ‰çš„è·¯ä¸Šå·äº†ï¼Œè¦åŽ»å®šä¹‰ä¸€äº›å¤§å®¶éƒ½è§‰å¾—é‡è¦ï¼Œä½†æ²¡äººè¯´æ¸…æ¥šçš„é—®é¢˜ã€‚[S2]ç¡®å®žã€‚å¬ä½ è¿™ä¹ˆä¸€è¯´ï¼Œæ„Ÿè§‰è¿™ä¸ªæƒ…å¢ƒæ‰©å±•ï¼ŒContext Scalingï¼Œç¡®å®žç»™äººå·¥æ™ºèƒ½æŒ‡äº†ä¸€ä¸ªæŒºä¸ä¸€æ ·çš„æ–¹å‘ã€‚ä¸å†æ˜¯å†·å†°å†°çš„è®¡ç®—ï¼Œè€Œæ˜¯è¦å˜å¾—æ›´æ‡‚æˆ‘ä»¬äººç±»ï¼Œæ›´æ‡‚è¿™ä¸ªå¤æ‚çš„ä¸–ç•Œã€‚[S1]æ˜¯å•Šï¼Œä»–è¯´è¿™å¯èƒ½æ˜¯é€šå¾€é€šç”¨äººå·¥æ™ºèƒ½ï¼Œå°±æ˜¯AGIï¼Œéžå¸¸å…³é”®çš„ä¸€æ­¥ã€‚[S2]å—¯ï¼Œå¬èµ·æ¥æœªæ¥å¯æœŸå•Šã€‚",
        "model": "MOSS-TTSD-v0.5",
        "audio_mode": "Role",
        "prompt_audio_1_url": "https://gitee.com/wei-xiaohui1/test1/raw/master/zh_spk1_moon.wav",
        "prompt_text_1": "å‘¨ä¸€åˆ°å‘¨äº”ï¼Œæ¯å¤©æ—©æ™¨ä¸ƒç‚¹åŠåˆ°ä¹ç‚¹åŠçš„ç›´æ’­ç‰‡æ®µã€‚è¨€ä¸‹ä¹‹æ„å‘¢ï¼Œå°±æ˜¯åºŸè¯æœ‰ç‚¹å¤šï¼Œå¤§å®¶ä¹Ÿåˆ«å«Œå¼ƒï¼Œå› ä¸ºè¿™éƒ½æ˜¯ç›´æ’­é—´æœ€çœŸå®žçš„çŠ¶æ€äº†ã€‚",
        "prompt_audio_2_url": "https://gitee.com/wei-xiaohui1/test1/raw/master/zh_spk2_moon.wav",
        "prompt_text_2": "å¦‚æžœå¤§å®¶æƒ³å¬åˆ°æ›´ä¸°å¯Œæ›´åŠæ—¶çš„ç›´æ’­å†…å®¹ï¼Œè®°å¾—åœ¨å‘¨ä¸€åˆ°å‘¨äº”å‡†æ—¶è¿›å…¥ç›´æ’­é—´ï¼Œå’Œå¤§å®¶ä¸€èµ·ç•…èŠæ–°æ¶ˆè´¹æ–°ç§‘æŠ€æ–°è¶‹åŠ¿ã€‚",
        "use_normalize": True
    })
    task_id = result.get("task_id")
    if not task_id:
        raise ValueError("Task ID not found in the response")
    print(f"Task ID: {task_id}")
    task = poll_task(task_id)
    if task.get("status") == "success":
        # Do something with the task result here
        print("Task completed successfully!")